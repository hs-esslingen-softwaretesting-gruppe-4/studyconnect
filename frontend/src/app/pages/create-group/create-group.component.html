<section class="create-group">
  <header class="create-group__header">
    <div>
      <h1>Create a new group</h1>
      <p class="create-group__subtitle">
        Set the basics and invite members to your study space.
      </p>
    </div>
  </header>

  <mat-card class="create-group__card">
    <mat-card-content>
      <form class="create-group__form" [formGroup]="createGroupForm" (ngSubmit)="onSubmit()">
        <div class="create-group__grid">
          <mat-form-field appearance="outline">
            <mat-label>Group name</mat-label>
            <input
              matInput
              formControlName="name"
              placeholder="e.g. Software Testing Crew"
            />
            @if (createGroupForm.get('name')?.hasError('required') && createGroupForm.get('name')?.touched) {
              <mat-error>Group name is required.</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Visibility</mat-label>
            <mat-select formControlName="is_public">
              <mat-option [value]="true">Public</mat-option>
              <mat-option [value]="false">Private</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Max members</mat-label>
            <input
              matInput
              type="number"
              min="2"
              formControlName="max_members"
              placeholder="e.g. 20"
            />
            <mat-hint>Minimum 2 members.</mat-hint>
            @if (createGroupForm.get('max_members')?.hasError('required') && createGroupForm.get('max_members')?.touched) {
              <mat-error>Max members is required.</mat-error>
            } @else if (createGroupForm.get('max_members')?.hasError('min') && createGroupForm.get('max_members')?.touched) {
              <mat-error>Enter a number of at least 2.</mat-error>
            }
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="create-group__field--full">
          <mat-label>Description</mat-label>
          <textarea
            matInput
            rows="4"
            formControlName="description"
            placeholder="Share what this group is about (max. 255 characters)."
            maxlength="255"
          ></textarea>
        </mat-form-field>

        <section class="create-group__section">
          <div class="create-group__section-header">
            <div>
              <h2>Members</h2>
              <p class="create-group__section-subtitle">
                Invite members to join the group.
              </p>
            </div>
            <span class="create-group__count">{{ members().length }}</span>
          </div>

          <mat-form-field appearance="outline" class="create-group__field--full">
            <mat-label>Add members</mat-label>
            <input
              matInput
              type="text"
              [formControl]="memberSearchControl"
              [matAutocomplete]="memberAuto"
              placeholder="Search by name or email"
            />
            <mat-autocomplete
              #memberAuto="matAutocomplete"
              [displayWith]="displayAutocompleteLabel"
              (optionSelected)="onMemberSelected($event)"
            >
              @for (option of filteredMemberOptions(); track option.value) {
                <mat-option [value]="option">{{ option.label }}</mat-option>
              }
            </mat-autocomplete>
            <mat-hint>Select a person to add them.</mat-hint>
          </mat-form-field>

          @if (memberCards().length > 0) {
            <div class="create-group__cards">
              @for (member of memberCards(); track member.id) {
                <div class="create-group__user-card">
                  <img
                    class="create-group__avatar"
                    src="assets/profile_placeholder.png"
                    alt="Profile placeholder"
                  />
                  <div class="create-group__user-details">
                    <span class="create-group__user-name">{{ member.name }}</span>
                  </div>
                  <button
                    mat-icon-button
                    type="button"
                    aria-label="Remove member"
                    (click)="removeMember(member.id)"
                  >
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              }
            </div>
          } @else {
            <div class="create-group__empty">No members added yet.</div>
          }
        </section>

        <section class="create-group__section">
          <div class="create-group__section-header">
            <div>
              <h2>Admins</h2>
              <p class="create-group__section-subtitle">
                Assign who can manage this group.
              </p>
            </div>
            <span class="create-group__count">{{ admins().length }}</span>
          </div>

          <mat-form-field appearance="outline" class="create-group__field--full">
            <mat-label>Add admins</mat-label>
            <input
              matInput
              type="text"
              [formControl]="adminSearchControl"
              [matAutocomplete]="adminAuto"
              placeholder="Search by name or email"
            />
            <mat-autocomplete
              #adminAuto="matAutocomplete"
              [displayWith]="displayAutocompleteLabel"
              (optionSelected)="onAdminSelected($event)"
            >
              @for (option of filteredAdminOptions(); track option.value) {
                <mat-option [value]="option">{{ option.label }}</mat-option>
              }
            </mat-autocomplete>
            <mat-hint>Select a person to add them.</mat-hint>
          </mat-form-field>

          @if (adminCards().length > 0) {
            <div class="create-group__cards">
              @for (admin of adminCards(); track admin.id) {
                <div class="create-group__user-card">
                  <img
                    class="create-group__avatar"
                    src="assets/profile_placeholder.png"
                    alt="Profile placeholder"
                  />
                  <div class="create-group__user-details">
                    <span class="create-group__user-name">{{ admin.name }}</span>
                  </div>
                  <button
                    mat-icon-button
                    type="button"
                    aria-label="Remove admin"
                    (click)="removeAdmin(admin.id)"
                  >
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              }
            </div>
          } @else {
            <div class="create-group__empty">No admins added yet.</div>
          }
        </section>

        <div class="create-group__actions">
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="createGroupForm.invalid || isSubmitting()"
          >
            Create group
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</section>
